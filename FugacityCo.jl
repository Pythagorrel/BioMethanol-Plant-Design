module FugacityCo

export fugacity

# ==========================================
# 1. DATA STRUCTURES & SPECIES DEFINITIONS
# ==========================================

struct Species
    name::String
    Tc::Float64 # Kelvin
    Pc::Float64 # bar
    omega::Float64 # Acentric factor
end

# Defined using Chemical Formulas as keys for the dictionary
const SPECS = [
    Species("CH3OH", 512.6, 80.97, 0.564),  # Methanol
    Species("CO2",   304.2, 73.83, 0.224),
    Species("CO",    132.9, 34.99, 0.048),
    Species("H2",    33.19, 13.13, -0.216), # Hydrogen
    Species("H2O",   647.1, 220.55, 0.345)  # Water
]

# ==========================================
# 2. LEE-KESLER DATA (Hardcoded)
# ==========================================

# Row headers (Tr) and Col headers (Pr)
const LK_TR_ROWS = [0.30, 0.35, 0.40, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85, 0.90, 0.93, 0.95, 0.97, 0.98, 0.99, 1.00, 1.01, 1.02, 1.05, 1.10, 1.15, 1.20, 1.30, 1.40, 1.50, 1.60, 1.70, 1.80, 1.90, 2.00, 2.20, 2.40, 2.60, 2.80, 3.00, 3.50, 4.00]
const LK_PR_COLS_LOW = [0.01, 0.05, 0.10, 0.20, 0.40, 0.60, 0.80, 1.00]
const LK_PR_COLS_HIGH = [1.0, 1.2, 1.5, 2.0, 3.0, 5.0, 7.0, 10.0]

# Table D.13 (Phi0 Low P)
const PHI0_LOW_DATA = [
    0.0002 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000;
    0.0034 0.0007 0.0003 0.0002 0.0001 0.0001 0.0001 0.0000;
    0.0272 0.0055 0.0028 0.0014 0.0007 0.0005 0.0004 0.0003;
    0.1321 0.0266 0.0135 0.0069 0.0036 0.0025 0.0020 0.0016;
    0.4529 0.0912 0.0461 0.0235 0.0122 0.0085 0.0067 0.0055;
    0.9817 0.2432 0.1227 0.0625 0.0325 0.0225 0.0176 0.0146;
    0.9840 0.5383 0.2716 0.1384 0.0718 0.0497 0.0386 0.0321;
    0.9886 0.9419 0.5212 0.2655 0.1374 0.0948 0.0738 0.0611;
    0.9908 0.9528 0.9057 0.4560 0.2360 0.1626 0.1262 0.1045;
    0.9931 0.9616 0.9226 0.7178 0.3715 0.2559 0.1982 0.1641;
    0.9931 0.9683 0.9354 0.8730 0.5445 0.3750 0.2904 0.2404;
    0.9954 0.9727 0.9462 0.8933 0.7534 0.5188 0.4018 0.3319;
    0.9954 0.9772 0.9550 0.9099 0.8204 0.6823 0.5297 0.4375;
    0.9954 0.9795 0.9594 0.9183 0.8375 0.7551 0.6109 0.5058;
    0.9954 0.9817 0.9616 0.9226 0.8472 0.7709 0.6668 0.5521;
    0.9954 0.9817 0.9638 0.9268 0.8570 0.7852 0.7112 0.5984;
    0.9954 0.9817 0.9638 0.9290 0.8610 0.7925 0.7211 0.6223;
    0.9977 0.9840 0.9661 0.9311 0.8650 0.7980 0.7295 0.6442;
    0.9977 0.9840 0.9661 0.9333 0.8690 0.8035 0.7379 0.6668;
    0.9977 0.9840 0.9683 0.9354 0.8730 0.8110 0.7464 0.6792;
    0.9977 0.9840 0.9683 0.9376 0.8770 0.8166 0.7551 0.6902;
    0.9977 0.9863 0.9705 0.9441 0.8872 0.8318 0.7762 0.7194;
    0.9977 0.9886 0.9750 0.9506 0.9016 0.8531 0.8072 0.7586;
    0.9977 0.9886 0.9795 0.9572 0.9141 0.8730 0.8318 0.7907;
    0.9977 0.9908 0.9817 0.9616 0.9247 0.8892 0.8531 0.8166;
    0.9977 0.9931 0.9863 0.9705 0.9419 0.9141 0.8872 0.8590;
    0.9977 0.9931 0.9886 0.9772 0.9550 0.9333 0.9120 0.8892;
    1.0000 0.9954 0.9908 0.9817 0.9638 0.9462 0.9290 0.9141;
    1.0000 0.9954 0.9931 0.9863 0.9727 0.9572 0.9441 0.9311;
    1.0000 0.9977 0.9954 0.9886 0.9772 0.9661 0.9550 0.9462;
    1.0000 0.9977 0.9954 0.9908 0.9817 0.9727 0.9661 0.9572;
    1.0000 0.9977 0.9954 0.9931 0.9863 0.9795 0.9727 0.9661;
    1.0000 0.9977 0.9977 0.9954 0.9886 0.9840 0.9795 0.9727;
    1.0000 1.0000 0.9977 0.9977 0.9931 0.9908 0.9886 0.9840;
    1.0000 1.0000 1.0000 0.9977 0.9977 0.9954 0.9931 0.9931;
    1.0000 1.0000 1.0000 1.0000 1.0000 0.9977 0.9977 0.9977;
    1.0000 1.0000 1.0000 1.0000 1.0000 1.0000 1.0023 1.0023;
    1.0000 1.0000 1.0000 1.0000 1.0023 1.0023 1.0046 1.0046;
    1.0000 1.0000 1.0000 1.0023 1.0023 1.0046 1.0069 1.0093;
    1.0000 1.0000 1.0000 1.0023 1.0046 1.0069 1.0093 1.0116;
]

# Table D.14 (Phi1 Low P)
const PHI1_LOW_DATA = [
    0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000;
    0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000;
    0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000;
    0.0002 0.0002 0.0002 0.0002 0.0002 0.0002 0.0002 0.0002;
    0.0014 0.0014 0.0014 0.0014 0.0014 0.0014 0.0013 0.0013;
    0.9705 0.0069 0.0068 0.0068 0.0066 0.0065 0.0064 0.0063;
    0.9795 0.0227 0.0226 0.0223 0.0220 0.0216 0.0213 0.0210;
    0.9863 0.9311 0.0572 0.0568 0.0559 0.0551 0.0543 0.0535;
    0.9908 0.9528 0.9036 0.1182 0.1163 0.1147 0.1131 0.1116;
    0.9931 0.9683 0.9332 0.2112 0.2078 0.2050 0.2022 0.1994;
    0.9954 0.9772 0.9550 0.9057 0.3302 0.3257 0.3212 0.3168;
    0.9977 0.9863 0.9705 0.9375 0.4774 0.4708 0.4654 0.4590;
    0.9977 0.9908 0.9795 0.9594 0.9141 0.6323 0.6250 0.6165;
    0.9977 0.9931 0.9840 0.9705 0.9354 0.8953 0.7227 0.7144;
    0.9977 0.9931 0.9885 0.9750 0.9484 0.9183 0.7888 0.7797;
    1.0000 0.9954 0.9908 0.9795 0.9594 0.9354 0.9078 0.8413;
    1.0000 0.9954 0.9908 0.9817 0.9638 0.9440 0.9225 0.8729;
    1.0000 0.9954 0.9931 0.9840 0.9683 0.9528 0.9332 0.9036;
    1.0000 0.9977 0.9931 0.9863 0.9727 0.9594 0.9440 0.9311;
    1.0000 0.9977 0.9931 0.9885 0.9772 0.9638 0.9528 0.9462;
    1.0000 0.9977 0.9954 0.9908 0.9795 0.9705 0.9616 0.9572;
    1.0000 0.9977 0.9977 0.9954 0.9885 0.9863 0.9840 0.9840;
    1.0000 1.0000 1.0000 1.0000 1.0023 1.0046 1.0093 1.0163;
    1.0000 1.0000 1.0023 1.0046 1.0116 1.0186 1.0257 1.0375;
    1.0000 1.0023 1.0046 1.0069 1.0163 1.0280 1.0399 1.0544;
    1.0000 1.0023 1.0069 1.0116 1.0257 1.0399 1.0544 1.0716;
    1.0000 1.0046 1.0069 1.0139 1.0304 1.0471 1.0642 1.0815;
    1.0000 1.0046 1.0069 1.0163 1.0328 1.0496 1.0666 1.0865;
    1.0000 1.0046 1.0069 1.0163 1.0328 1.0496 1.0691 1.0865;
    1.0000 1.0046 1.0093 1.0163 1.0328 1.0496 1.0691 1.0865;
    1.0000 1.0046 1.0069 1.0163 1.0328 1.0496 1.0666 1.0840;
    1.0000 1.0046 1.0069 1.0163 1.0328 1.0496 1.0666 1.0815;
    1.0000 1.0046 1.0069 1.0163 1.0304 1.0471 1.0642 1.0815;
    1.0000 1.0046 1.0069 1.0139 1.0304 1.0447 1.0593 1.0765;
    1.0000 1.0046 1.0069 1.0139 1.0280 1.0423 1.0568 1.0716;
    1.0000 1.0023 1.0069 1.0139 1.0257 1.0399 1.0544 1.0666;
    1.0000 1.0023 1.0069 1.0116 1.0257 1.0375 1.0496 1.0642;
    1.0000 1.0023 1.0069 1.0116 1.0233 1.0352 1.0471 1.0593;
    1.0000 1.0023 1.0046 1.0023 1.0209 1.0304 1.0423 1.0520;
    1.0000 1.0023 1.0046 1.0093 1.0186 1.0280 1.0375 1.0471;
]

# Table D.15 (Phi0 High P)
const PHI0_HIGH_DATA = [
    0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000;
    0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000;
    0.0003 0.0003 0.0003 0.0002 0.0002 0.0002 0.0002 0.0003;
    0.0016 0.0014 0.0012 0.0010 0.0008 0.0008 0.0009 0.0012;
    0.0055 0.0048 0.0041 0.0034 0.0028 0.0025 0.0027 0.0034;
    0.0146 0.0127 0.0107 0.0089 0.0072 0.0063 0.0066 0.0080;
    0.0321 0.0277 0.0234 0.0193 0.0154 0.0132 0.0135 0.0160;
    0.0611 0.0527 0.0445 0.0364 0.0289 0.0244 0.0245 0.0282;
    0.1045 0.0902 0.0759 0.0619 0.0488 0.0406 0.0402 0.0453;
    0.1641 0.1413 0.1188 0.0966 0.0757 0.0625 0.0610 0.0673;
    0.2404 0.2065 0.1738 0.1409 0.1102 0.0899 0.0867 0.0942;
    0.3319 0.2858 0.2399 0.1945 0.1517 0.1227 0.1175 0.1256;
    0.4375 0.3767 0.3162 0.2564 0.1995 0.1607 0.1524 0.1611;
    0.5058 0.4355 0.3656 0.2972 0.2307 0.1854 0.1754 0.1841;
    0.5521 0.4764 0.3999 0.3251 0.2523 0.2028 0.1910 0.2000;
    0.5984 0.5164 0.4345 0.3532 0.2748 0.2203 0.2075 0.2163;
    0.6223 0.5370 0.4529 0.3681 0.2864 0.2296 0.2158 0.2244;
    0.6442 0.5572 0.4699 0.3828 0.2978 0.2388 0.2244 0.2328;
    0.6668 0.5781 0.4875 0.3972 0.3097 0.2483 0.2328 0.2415;
    0.6792 0.5970 0.5047 0.4121 0.3214 0.2576 0.2415 0.2500;
    0.6902 0.6166 0.5224 0.4266 0.3334 0.2673 0.2506 0.2582;
    0.7194 0.6607 0.5728 0.4710 0.3690 0.2958 0.2773 0.2844;
    0.7586 0.7112 0.6412 0.5408 0.4285 0.3451 0.3228 0.3296;
    0.7907 0.7499 0.6918 0.6026 0.4875 0.3954 0.3690 0.3750;
    0.8166 0.7834 0.7328 0.6546 0.5420 0.4446 0.4150 0.4198;
    0.8590 0.8318 0.7943 0.7345 0.6383 0.5383 0.5058 0.5093;
    0.8892 0.8690 0.8395 0.7925 0.7145 0.6237 0.5902 0.5943;
    0.9141 0.8974 0.8730 0.8375 0.7745 0.6966 0.6668 0.6714;
    0.9311 0.9183 0.8995 0.8710 0.8222 0.7586 0.7328 0.7430;
    0.9462 0.9354 0.9204 0.8995 0.8610 0.8091 0.7907 0.8054;
    0.9572 0.9484 0.9376 0.9204 0.8913 0.8531 0.8414 0.8590;
    0.9661 0.9594 0.9506 0.9376 0.9162 0.8872 0.8831 0.9057;
    0.9727 0.9683 0.9616 0.9528 0.9354 0.9183 0.9183 0.9462;
    0.9840 0.9817 0.9795 0.9727 0.9661 0.9616 0.9727 1.0093;
    0.9931 0.9908 0.9908 0.9886 0.9863 0.9931 1.0116 1.0568;
    0.9977 0.9977 0.9977 0.9977 1.0023 1.0162 1.0399 1.0889;
    1.0023 1.0023 1.0046 1.0069 1.0116 1.0328 1.0593 1.1117;
    1.0046 1.0069 1.0069 1.0116 1.0209 1.0423 1.0740 1.1298;
    1.0093 1.0116 1.0139 1.0186 1.0304 1.0593 1.0914 1.1508;
    1.0116 1.0139 1.0162 1.0233 1.0375 1.0666 1.0990 1.1588;
]

# Table D.16 (Phi1 High P)
const PHI1_HIGH_DATA = [
    0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000;
    0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000;
    0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000;
    0.0002 0.0002 0.0002 0.0002 0.0001 0.0001 0.0001 0.0001;
    0.0013 0.0013 0.0013 0.0012 0.0011 0.0009 0.0008 0.0006;
    0.0063 0.0062 0.0061 0.0058 0.0053 0.0045 0.0039 0.0031;
    0.0210 0.0207 0.0202 0.0194 0.0179 0.0154 0.0133 0.0108;
    0.0536 0.0527 0.0516 0.0497 0.0461 0.0401 0.0350 0.0289;
    0.1117 0.1102 0.1079 0.1040 0.0970 0.0851 0.0752 0.0629;
    0.1995 0.1972 0.1932 0.1871 0.1754 0.1552 0.1387 0.1178;
    0.3170 0.3133 0.3076 0.2978 0.2812 0.2512 0.2265 0.1954;
    0.4592 0.4539 0.4457 0.4325 0.4093 0.3698 0.3365 0.2951;
    0.6166 0.6095 0.5998 0.5834 0.5546 0.5058 0.4645 0.4130;
    0.7145 0.7063 0.6950 0.6761 0.6457 0.5916 0.5470 0.4898;
    0.7798 0.7691 0.7568 0.7379 0.7063 0.6501 0.6026 0.5432;
    0.8414 0.8318 0.8185 0.7998 0.7656 0.7096 0.6607 0.5984;
    0.8730 0.8630 0.8492 0.8298 0.7962 0.7379 0.6887 0.6266;
    0.9036 0.8913 0.8790 0.8590 0.8241 0.7674 0.7178 0.6546;
    0.9311 0.9204 0.9078 0.8872 0.8531 0.7962 0.7464 0.6823;
    0.9462 0.9462 0.9333 0.9162 0.8831 0.8241 0.7745 0.7096;
    0.9572 0.9661 0.9594 0.9419 0.9099 0.8531 0.8035 0.7379;
    0.9840 0.9954 1.0186 1.0162 0.9886 0.9354 0.8872 0.8222;
    1.0162 1.0280 1.0593 1.0990 1.1015 1.0617 1.0186 0.9572;
    1.0375 1.0520 1.0814 1.1376 1.1858 1.1722 1.1403 1.0864;
    1.0544 1.0691 1.0990 1.1588 1.2388 1.2647 1.2474 1.2050;
    1.0715 1.0914 1.1194 1.1776 1.2853 1.3868 1.4125 1.4061;
    1.0814 1.0990 1.1298 1.1858 1.2942 1.4488 1.5171 1.5524;
    1.0864 1.1041 1.1350 1.1858 1.2942 1.4689 1.5740 1.6520;
    1.0864 1.1041 1.1350 1.1858 1.2883 1.4689 1.5996 1.7140;
    1.0864 1.1041 1.1324 1.1803 1.2794 1.4622 1.6033 1.7458;
    1.0839 1.1015 1.1298 1.1749 1.2706 1.4488 1.5959 1.7620;
    1.0814 1.0990 1.1272 1.1695 1.2618 1.4355 1.5849 1.7620;
    1.0814 1.0965 1.1220 1.1641 1.2503 1.4191 1.5704 1.7539;
    1.0765 1.0914 1.1143 1.1535 1.2331 1.3900 1.5346 1.7219;
    1.0715 1.0864 1.1066 1.1429 1.2190 1.3614 1.4997 1.6866;
    1.0666 1.0814 1.1015 1.1350 1.2023 1.3397 1.4689 1.6482;
    1.0641 1.0765 1.0940 1.1272 1.1912 1.3183 1.4388 1.6144;
    1.0593 1.0715 1.0889 1.1194 1.1803 1.3002 1.4158 1.5813;
    1.0520 1.0617 1.0789 1.1041 1.1561 1.2618 1.3614 1.5101;
    1.0471 1.0544 1.0691 1.0914 1.1403 1.2303 1.3213 1.4555;
]

# ==========================================
# 3. INTERPOLATION FUNCTIONS
# ==========================================

function bilinear_interpolate(x_vals, y_vals, grid, x_target, y_target)
    # x = Rows (Tr), y = Cols (Pr)
    
    i = findlast(v -> v <= x_target, x_vals)
    j = findlast(v -> v <= y_target, y_vals)

    if isnothing(i) i = 1 end
    if isnothing(j) j = 1 end
    if i >= length(x_vals) i = length(x_vals) - 1 end
    if j >= length(y_vals) j = length(y_vals) - 1 end

    x1, x2 = x_vals[i], x_vals[i+1]
    y1, y2 = y_vals[j], y_vals[j+1]
    
    Q11 = grid[i, j]
    Q21 = grid[i+1, j]
    Q12 = grid[i, j+1]
    Q22 = grid[i+1, j+1]

    denom = (x2 - x1) * (y2 - y1)
    
    if denom == 0 return Q11 end

    t1 = (x2 - x_target) * (y2 - y_target) * Q11
    t2 = (x_target - x1) * (y2 - y_target) * Q21
    t3 = (x2 - x_target) * (y_target - y1) * Q12
    t4 = (x_target - x1) * (y_target - y1) * Q22

    return (t1 + t2 + t3 + t4) / denom
end

function get_phi_lee_kesler(T, P, s::Species)
    Tr = T / s.Tc
    Pr = P / s.Pc

    if Tr > 4.0
        Tr = 4.0
    elseif Tr < 0.3
        return NaN
    end

    if Pr <= 1.0
        phi0 = bilinear_interpolate(LK_TR_ROWS, LK_PR_COLS_LOW, PHI0_LOW_DATA, Tr, Pr)
        phi1 = bilinear_interpolate(LK_TR_ROWS, LK_PR_COLS_LOW, PHI1_LOW_DATA, Tr, Pr)
    else
        phi0 = bilinear_interpolate(LK_TR_ROWS, LK_PR_COLS_HIGH, PHI0_HIGH_DATA, Tr, Pr)
        phi1 = bilinear_interpolate(LK_TR_ROWS, LK_PR_COLS_HIGH, PHI1_HIGH_DATA, Tr, Pr)
    end
    
    return phi0 * (phi1 ^ s.omega)
end

function get_phi_pitzer(T, P, s::Species)
    Tr = T / s.Tc
    Pr = P / s.Pc
    
    B0 = 0.083 - (0.422 / (Tr^1.6))
    B1 = 0.139 - (0.172 / (Tr^4.2))
    B_hat = B0 + s.omega * B1
    
    ln_phi = B_hat * (Pr / Tr)
    return exp(ln_phi)
end

# ==========================================
# 4. EXPORTED FUNCTION
# ==========================================

"""
    fugacity(T, P)

Calculate the fugacity coefficients for a predefined set of species (CH3OH, CO2, CO, H2, H2O)
at the given temperature `T` (Kelvin) and pressure `P` (bar).

Returns a Dictionary where keys are chemical formulas and values are the fugacity coefficients.
"""
function fugacity(T, P)
    results = Dict{String, Float64}()
    
    for s in SPECS
        val = 0.0
        if s.name == "H2" 
            val = get_phi_pitzer(T, P, s)
        else
            val = get_phi_lee_kesler(T, P, s)
        end
        results[s.name] = val
    end
    
    return results
end

end # module